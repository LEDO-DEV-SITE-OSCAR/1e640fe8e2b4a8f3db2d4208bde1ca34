<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quay Số Xổ Số Miền Bắc</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f3f3f3;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 400px;
            text-align: center;
        }

        .container h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .numbers {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #copyMessage {
            display: none;
            color: green;
            margin-top: 20px;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>Dàn Số Xổ Số Miền Bắc</h1>
        <div id="numbers" class="numbers">Loading...</div>
        <button id="generateButton">Tạo Dàn Số</button>
        <button id="copyButton">Sao Chép Dàn Số</button>
        <div id="copyMessage">Copy Thành Công!</div>
    </div>

    <script>
        const axios = require('axios');
        const crypto = require('crypto');

        // Hàm để tải và phân tích dữ liệu từ URL
        async function getDataFromCSV(url) {
            const data = [];
            try {
                const response = await axios.get(url);
                const rawData = response.data;

                // Phân tích dữ liệu CSV
                rawData.split('\n').forEach(line => {
                    const columns = line.split(',');
                    if (columns.length > 1) {
                        const date = columns[0];
                        const numbers = columns.slice(1).map(num => num.padStart(5, '0')); // Đảm bảo số có 5 chữ số

                        // Kiểm tra và loại bỏ các số không hợp lệ
                        const validNumbers = numbers.filter(num => /^[0-9]+$/.test(num)); // Chỉ lấy các số hợp lệ
                        if (validNumbers.length > 0) {
                            data.push({ date, numbers: validNumbers });
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching data:', error);
            }
            return data;
        }

        // Hàm để tính toán các con số có tỉ lệ chiến thắng cao nhất cho ngày tiếp theo
        function analyzeData(data, numberCount = 39, highPercent = 50, lowPercent = 50) {
            const allNumbers = [];

            // Lấy tất cả các con số từ dữ liệu
            data.forEach(item => {
                item.numbers.forEach(number => {
                    const lastTwoDigits = number.slice(-2); // Lấy 2 số cuối
                    allNumbers.push(lastTwoDigits);
                });
            });

            // Đếm tần suất xuất hiện của các số
            const frequencyMap = {};
            allNumbers.forEach(num => {
                frequencyMap[num] = (frequencyMap[num] || 0) + 1;
            });

            // Sắp xếp theo tần suất từ cao đến thấp
            const sortedNumbers = Object.entries(frequencyMap)
                .sort((a, b) => b[1] - a[1])
                .map(([num]) => num);

            // Xác định số lượng cho các nhóm cao và thấp
            const highCount = Math.floor(numberCount * (highPercent / 100));
            const lowCount = numberCount - highCount;

            // Lấy các số có tần suất cao nhất và thấp nhất
            const highFrequencyNumbers = sortedNumbers.slice(0, highCount);
            const lowFrequencyNumbers = sortedNumbers.slice(-lowCount);

            // Tính ngẫu nhiên cho các con số
            const resultNumbers = [];

            // Thêm các số tần suất cao vào kết quả
            highFrequencyNumbers.forEach(num => {
                if (Math.random() < highPercent / 100) {  // Tỉ lệ chiến thắng cao
                    resultNumbers.push(num);
                }
            });

            // Thêm các số tần suất thấp vào kết quả
            lowFrequencyNumbers.forEach(num => {
                if (Math.random() < lowPercent / 100) {  // Tỉ lệ chiến thắng thấp
                    resultNumbers.push(num);
                }
            });

            // Nếu chưa đủ số lượng, bổ sung thêm số ngẫu nhiên từ các số khác
            while (resultNumbers.length < numberCount) {
                const randomNum = sortedNumbers[Math.floor(Math.random() * sortedNumbers.length)];
                if (!resultNumbers.includes(randomNum)) {
                    resultNumbers.push(randomNum);
                }
            }

            return resultNumbers.sort();
        }

        // Phương thức để tạo một hạt giống (seed) từ ngày hiện tại
        function createSeedForToday() {
            const currentDate = new Date();
            const dateString = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${currentDate.getDate().toString().padStart(2, '0')}`;
            return crypto.createHash('sha256').update(dateString).digest('hex');
        }

        // Hàm quay Monte Carlo
        function monteCarloSimulation(data, numberCount, highPercent, lowPercent, iterations = 1000) {
            const results = [];

            // Lặp qua số lần mô phỏng
            for (let i = 0; i < iterations; i++) {
                const result = analyzeData(data, numberCount, highPercent, lowPercent);
                results.push(result);
            }

            // Sử dụng hạt giống (seed) để xác định kết quả cố định cho ngày hôm đó
            const seed = createSeedForToday();
            const hashValue = parseInt(seed.substring(0, 8), 16); // Chỉ lấy 8 ký tự đầu của hash
            const index = hashValue % results.length; // Đảm bảo chỉ lấy một kết quả từ mô phỏng
            return results[index];
        }

        // Hàm để hiển thị kết quả
        async function generateNumbersForNextDay() {
            const url = 'https://raw.githubusercontent.com/khiemdoan/vietnam-lottery-xsmb-analysis/refs/heads/main/data/xsmb.csv';
            const data = await getDataFromCSV(url);
            
            // Lấy 39 con số có tỉ lệ chiến thắng cao nhất (có thể thay đổi numberCount)
            const highPercent = 70; // Tỉ lệ phần trăm cho các con số tần suất cao
            const lowPercent = 30;  // Tỉ lệ phần trăm cho các con số tần suất thấp
            const numbers = monteCarloSimulation(data, 39, highPercent, lowPercent);
            
            // Trả về kết quả cho người dùng
            const formattedDate = new Date().toLocaleDateString('vi-VN');
            const numbersString = numbers.join(', ');
            document.getElementById('numbers').textContent = `Dàn Số của ngày mới (${formattedDate}): ${numbersString}`;
            document.getElementById('numbers').dataset.numbers = numbersString;
        }

        // Hàm sao chép dàn số
        function copyNumbers() {
            const numbers = document.getElementById('numbers').dataset.numbers;
            navigator.clipboard.writeText(numbers)
                .then(() => {
                    const copyMessage = document.getElementById('copyMessage');
                    copyMessage.style.display = 'block';
                    setTimeout(() => {
                        copyMessage.style.display = 'none';
                    }, 2000);
                })
                .catch(err => console.error('Failed to copy: ', err));
        }

        // Thêm sự kiện cho nút tạo dàn số và sao chép
        document.getElementById('generateButton').addEventListener('click', generateNumbersForNextDay);
        document.getElementById('copyButton').addEventListener('click', copyNumbers);

        // Khi load trang, tự động tạo dàn số
        generateNumbersForNextDay();

    </script>
</body>
</html>
