<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phân tích Xổ Số Miền Bắc</title>
    <link rel="icon" href="lottery.png" type="image/png">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7fc;
        }
        .container {
            width: 80%;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            font-size: 2rem;
            margin-bottom: 20px;
        }
        label {
            font-size: 1.1rem;
            color: #333;
        }
        input {
            padding: 10px;
            font-size: 1rem;
            margin: 10px 0;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 1.1rem;
        }
        button:hover {
            background-color: #45a049;
        }
        #result {
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            text-align: center;
        }
        #copyButton {
            background-color: #008CBA;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 50%;
        }
        #copyButton:hover {
            background-color: #007bb5;
        }
        #copyMessage {
            display: none;
            color: green;
            font-size: 1rem;
            margin-top: 10px;
            text-align: center;
        }
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                width: 90%;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Phân tích Xổ Số Miền Bắc</h1>
    <label id="totalDaysLabel" style="font-weight: bold;">Tổng Số Ngày Đã Quay: Đang tải...</label>
    <br>
    <label for="daysAgo">Nhập số ngày quá khứ bạn muốn phân tích (ví dụ: 1618 ngày):</label>
    <input type="number" id="daysAgo" placeholder="Nhập số ngày quá khứ" min="1" required />
    <label for="numberOfResults">Bạn muốn lấy bao nhiêu con số?</label>
<input type="number" id="numberOfResults" placeholder="Nhập số kết quả" min="1" required value="39" />
    <label for="numberOf3D">Số lượng 3D bạn muốn lấy:</label>
<input type="number" id="numberOf3D" placeholder="Nhập số lượng 3D" min="1" required value="7" />
    <label for="numberOf4D">Số lượng 4D bạn muốn lấy:</label>
<input type="number" id="numberOf4D" placeholder="Nhập số lượng 4D" min="1" required value="7" />
    <button onclick="processData()">Xử lý</button>
    <div id="result"></div>
    <button id="copyButton" onclick="copyToClipboard()">Sao chép kết quả</button>
    <div id="copyMessage" style="display: none;">Đã Copy!</div>
</div>

<script>
    // Biến toàn cục lưu trữ kết quả cố định
let fixedResult = null;
    // Hàm để lấy tổng số ngày đã quay từ URL
async function fetchTotalDays(url) {
    try {
        const response = await fetch(url);
        const data = await response.text();
        const lines = data.split('\n').filter(line => line.trim() !== '');
        return lines.length - 1; // Trừ 1 vì bỏ dòng tiêu đề
    } catch (error) {
        console.error('Lỗi khi tính tổng số ngày:', error.message);
        return 0;
    }
}

// Hàm để hiển thị tổng số ngày đã quay
async function initializeTotalDays() {
    const url = 'https://raw.githubusercontent.com/khiemdoan/vietnam-lottery-xsmb-analysis/refs/heads/main/data/xsmb.csv';
    const totalDays = await fetchTotalDays(url);
    const totalDaysLabel = document.getElementById('totalDaysLabel');
    totalDaysLabel.textContent = `Tổng Số Ngày Đã Quay: ${totalDays} ngày`;

    // Đảm bảo rằng khi nhập số ngày, chương trình hoạt động đúng
    const daysInput = document.getElementById('daysAgoInput');
    daysInput.max = totalDays; // Đảm bảo nhập không vượt quá số ngày đã quay
}

// Hàm để sinh số ngẫu nhiên có sử dụng seed
function seededRandom(seed) {
    let x = Math.sin(seed++) * 10000;
    return x - Math.floor(x);
}

// Hàm để lấy số ngẫu nhiên có sử dụng seed
function getSeededRandomNumbers(allNumbers, numberOfResults, seed) {
    const uniqueNumbers = Array.from(new Set(allNumbers));
    const randomResults = [];
    const availableCount = Math.min(uniqueNumbers.length, numberOfResults);

    for (let i = 0; i < availableCount; i++) {
        const randomIndex = Math.floor(seededRandom(seed + i) * uniqueNumbers.length);
        randomResults.push(uniqueNumbers[randomIndex]);
        uniqueNumbers.splice(randomIndex, 1); // Loại bỏ số đã chọn để tránh trùng lặp
    }

    return randomResults;
}

// Hàm để xử lý dữ liệu từ URL và hiển thị kết quả
async function processDataFromUrl(url, numberOfResults, daysAgo, numberOf3D, numberOf4D, highFreqPercentage = 70, seed = 1) {
    try {
        // Lấy tổng số ngày đã quay từ URL
        const totalDays = await fetchTotalDays(url);

        // Kiểm tra nếu daysAgo vượt quá tổng số ngày đã quay
        if (daysAgo > totalDays) {
            throw new Error(`Số ngày nhập vào vượt quá tổng số ngày đã quay (${totalDays} ngày).`);
        }

        // Xóa kết quả cố định nếu thay đổi số ngày
        if (fixedResult !== null) {
            fixedResult = null;
        }

        const response = await fetch(url);
        const data = await response.text();
        const lines = data.split('\n').filter(line => line.trim() !== '');

        if (lines.length === 0) {
            throw new Error('Dữ liệu không hợp lệ hoặc trống.');
        }

        let allNumbers = [];
        let threeDNumbers = [];
        let fourDNumbers = [];

        // Tính ngày gần đây để lọc dữ liệu
        const currentDate = new Date();
        const startDate = new Date(currentDate);
        startDate.setDate(currentDate.getDate() - daysAgo);

        lines.forEach((line, index) => {
    if (index === 0) return; // Bỏ qua dòng tiêu đề

    const columns = line.split(',');
    const date = new Date(columns[0]);

    if (isNaN(date)) {
        console.warn(`Dòng dữ liệu không hợp lệ (ngày không đúng định dạng): ${line}`);
        return; // Nếu ngày không hợp lệ, bỏ qua dòng này
    }

    if (date < startDate) return; // Bỏ qua dữ liệu ngoài phạm vi ngày nhập vào

    // Khởi tạo mảng để chứa các số cuối từ tất cả các cột
    const allNumbersFromLine = [];

    // Bắt đầu từ cột 2 (chỉ lấy kết quả, không lấy ngày tháng)
    for (let i = 1; i < columns.length; i++) {
        const result = columns[i].trim();  // Loại bỏ khoảng trắng
        if (result.length >= 2) {
            const lastTwoDigits = result.slice(-2); // Lấy 2 số cuối
            allNumbersFromLine.push(lastTwoDigits);
        }
    }

    // Thêm tất cả số cuối từ dòng vào mảng allNumbers
    allNumbers.push(...allNumbersFromLine);
});

// Lọc và xử lý dữ liệu như bạn yêu cầu
allNumbers = allNumbers.map(num => num.padStart(2, '0'));

// Đếm tần suất xuất hiện của từng số
const frequencyMap = {};
allNumbers.forEach(num => {
    if (!frequencyMap[num]) {
        frequencyMap[num] = 0;
    }
    frequencyMap[num]++;
});

const sortedNumbers = Object.keys(frequencyMap)
    .sort((a, b) => frequencyMap[b] - frequencyMap[a]);

// Tính số lượng số có tần suất cao và số ngẫu nhiên theo tỷ lệ phần trăm
const highFreqCount = Math.floor(numberOfResults * (highFreqPercentage / 100));
const randomCount = numberOfResults - highFreqCount;

// Lấy các số có tần suất cao
let result = sortedNumbers.slice(0, highFreqCount);

// Trộn số ngẫu nhiên sử dụng seed
const randomNumbers = getSeededRandomNumbers(allNumbers, randomCount, seed);
result = result.concat(randomNumbers);

// Lọc số trùng lặp và giới hạn số lượng kết quả
result = [...new Set(result)].slice(0, numberOfResults);

// Sắp xếp lại các số kết quả từ bé đến lớn
result.sort((a, b) => parseInt(a, 10) - parseInt(b, 10));

// Lưu trữ kết quả cố định
fixedResult = `
    Các số có khả năng xuất hiện cao nhất: ${result.join(', ')}
`;
document.getElementById('result').innerHTML = fixedResult;


    } catch (error) {
        console.error('Lỗi khi đọc dữ liệu từ URL hoặc xử lý:', error.message);
        document.getElementById('result').innerHTML = 'Đã xảy ra lỗi khi xử lý dữ liệu: ' + error.message;
    }
}




    // Gọi lại hàm mỗi khi có sự thay đổi (ví dụ: nhập ngày mới)
    function updateResultsOnChange() {
        const daysAgo = parseInt(document.getElementById('daysAgoInput').value, 10); // Nhận số ngày nhập vào
        processDataFromUrl("your-url-here", 10, daysAgo, 3, 4); // Ví dụ số kết quả, số 3D và 4D
    }

    function getRandomNumbers(allNumbers, numberOfResults, limit) {
        const uniqueNumbers = Array.from(new Set(allNumbers));
        const randomResults = [];
        const availableCount = Math.min(uniqueNumbers.length, numberOfResults);

        for (let i = 0; i < availableCount; i++) {
            const randomIndex = Math.floor(Math.random() * uniqueNumbers.length);
            randomResults.push(uniqueNumbers[randomIndex]);
            uniqueNumbers.splice(randomIndex, 1); // Loại bỏ số đã chọn
        }
        
        return randomResults;
    }

    function getMostFrequentNumbers(numbers, numberOfResults) {
        const frequencyMap = {};
        numbers.forEach(num => {
            if (!frequencyMap[num]) {
                frequencyMap[num] = 0;
            }
            frequencyMap[num]++;
        });

        const sortedNumbers = Object.keys(frequencyMap)
            .sort((a, b) => frequencyMap[b] - frequencyMap[a]);

        const topNumbers = sortedNumbers.slice(0, numberOfResults - numbers.length);
        return topNumbers;
    }

    function getRandomNumbers(allNumbers, numberOfResults, limit) {
        const uniqueNumbers = Array.from(new Set(allNumbers));
        const randomResults = [];
        const availableCount = Math.min(uniqueNumbers.length, numberOfResults);

        for (let i = 0; i < availableCount; i++) {
            const randomIndex = Math.floor(Math.random() * uniqueNumbers.length);
            randomResults.push(uniqueNumbers[randomIndex]);
            uniqueNumbers.splice(randomIndex, 1); // Loại bỏ số đã chọn
        }
        
        return randomResults;
    }

    function processData() {
        const daysAgo = parseInt(document.getElementById('daysAgo').value, 10);
        const numberOfResults = parseInt(document.getElementById('numberOfResults').value, 10);
        const numberOf3D = parseInt(document.getElementById('numberOf3D').value, 10);
        const numberOf4D = parseInt(document.getElementById('numberOf4D').value, 10);

        if (isNaN(daysAgo) || daysAgo <= 0) {
            alert('Vui lòng nhập số ngày hợp lệ.');
            return;
        }
        if (isNaN(numberOfResults) || numberOfResults <= 0) {
            alert('Vui lòng nhập số lượng kết quả hợp lệ.');
            return;
        }
        if (isNaN(numberOf3D) || numberOf3D <= 0) {
            alert('Vui lòng nhập số lượng 3D hợp lệ.');
            return;
        }
        if (isNaN(numberOf4D) || numberOf4D <= 0) {
            alert('Vui lòng nhập số lượng 4D hợp lệ.');
            return;
        }

        const url = 'https://raw.githubusercontent.com/khiemdoan/vietnam-lottery-xsmb-analysis/refs/heads/main/data/xsmb.csv';
        processDataFromUrl(url, numberOfResults, daysAgo, numberOf3D, numberOf4D);
    }

    function copyToClipboard() {
        const resultText = document.getElementById('result').innerText;
        if (!resultText) {
            alert('Không có kết quả để sao chép!');
            return;
        }
        navigator.clipboard.writeText(resultText)
            .then(() => {
                const copyMessage = document.getElementById('copyMessage');
                copyMessage.style.display = 'block';
                setTimeout(() => {
                    copyMessage.style.display = 'none';
                }, 2000);
            })
            .catch(err => {
                console.error('Lỗi sao chép: ', err);
            });
    }

    // Khởi tạo khi tải trang
    initializeTotalDays();
</script>


</body>
</html>
